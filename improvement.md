## ğŸ“‹ å½“å‰ç³»ç»Ÿæ¶æ„æ€»ç»“

### æ ¸å¿ƒç»„ä»¶
1. **System**: å•ä¾‹æ¨¡å¼ï¼Œç®¡ç†æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œ
2. **TaskManager**: ç®¡ç†ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸ
3. **Graph**: ç½‘ç»œæ‹“æ‰‘å’Œè·¯å¾„è§„åˆ’ï¼ˆFloydç®—æ³•ï¼‰
4. **State**: è°ƒåº¦çŠ¶æ€å¿«ç…§ï¼ˆç”¨äºè®¡ç®—ä¼˜åŒ–ï¼‰

### ç®—æ³•æµç¨‹
1. ç”¨æˆ·æäº¤ä»»åŠ¡ â†’ TaskManager
2. æ¯ç§’æ‰§è¡Œä¸€æ¬¡è°ƒåº¦è¿­ä»£
3. ä½¿ç”¨éšæœºåŒ–è´ªå¿ƒç®—æ³•ä¸ºä»»åŠ¡åˆ†é…è®¡ç®—èŠ‚ç‚¹
4. åŸºäº Lyapunov æ¼‚ç§»+æƒ©ç½šæ¡†æ¶ä¼˜åŒ–ï¼ˆé˜Ÿåˆ—ç¨³å®šæ€§ + æ€§èƒ½æŒ‡æ ‡ï¼‰

---

## ğŸ” å‘ç°çš„é—®é¢˜å’Œä¼˜åŒ–å»ºè®®

### 1. **å¹¶å‘å®‰å…¨é—®é¢˜** âš ï¸ é«˜ä¼˜å…ˆçº§

**é—®é¢˜**ï¼š
- `TaskManager` çš„ `Tasks`, `UserTasks`, `ActiveTasks` åœ¨å¤šä¸ªgoroutineä¸­è¯»å†™æ—¶æ²¡æœ‰åŠ é”
- `GetSystemInfo()` ä¸­å¯¹ TaskManager çš„è®¿é—®å¯èƒ½ä¸ `executeOneIteration()` å¹¶å‘å†²çª

**å»ºè®®**ï¼š
```go
type TaskManager struct {
    System      *System
    Tasks       map[string]*define.Task
    UserTasks   map[uint][]string
    ActiveTasks []string
    mutex       sync.RWMutex  // æ·»åŠ é”
}
```

### 2. **ç®—æ³•æ•ˆç‡é—®é¢˜**

#### 2.1 è°ƒåº¦ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦
**å½“å‰é—®é¢˜**ï¼š
- æ¯æ¬¡è°ƒåº¦å¯¹æ¯ä¸ªä»»åŠ¡éå†æ‰€æœ‰é€šä¿¡è®¾å¤‡ï¼š`O(Iters Ã— Tasks Ã— Comms)`
- State çš„æ·±æ‹·è´å¼€é”€å¾ˆå¤§ï¼ˆæ¯æ¬¡è¿­ä»£éƒ½å®Œæ•´æ‹·è´ï¼‰

**ä¼˜åŒ–å»ºè®®**ï¼š
- ä½¿ç”¨å¢é‡æ›´æ–°è€Œä¸æ˜¯å®Œæ•´æ‹·è´
- å¼•å…¥ä»»åŠ¡ä¼˜å…ˆçº§ï¼ˆæ•°æ®é‡å¤§ã€å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡ä¼˜å…ˆè°ƒåº¦ï¼‰
- æ·»åŠ æ—©åœæœºåˆ¶ï¼ˆcost è¿ç»­å‡ è½®ä¸å˜å°±åœæ­¢ï¼‰
- å¯ä»¥è€ƒè™‘æ¨¡æ‹Ÿé€€ç«ã€é—ä¼ ç®—æ³•ç­‰å¯å‘å¼ä¼˜åŒ–

#### 2.2 Floyd ç®—æ³•åªè¿è¡Œä¸€æ¬¡
**é—®é¢˜**ï¼š
- ç½‘ç»œæ‹“æ‰‘æ˜¯é™æ€çš„ï¼Œå®é™…åœºæ™¯ä¸­è®¾å¤‡å¯èƒ½åŠ¨æ€åŠ å…¥/é€€å‡º
- æ²¡æœ‰è€ƒè™‘é“¾è·¯è´¨é‡å˜åŒ–

**å»ºè®®**ï¼š
- æ·»åŠ  `Graph.Refresh()` æ–¹æ³•æ”¯æŒåŠ¨æ€æ›´æ–°
- æ”¯æŒèŠ‚ç‚¹ä¸Šçº¿/ä¸‹çº¿äº‹ä»¶
- è€ƒè™‘å®æ—¶è·¯å¾„è´¨é‡ç›‘æ§

### 3. **èµ„æºåˆ†é…ç­–ç•¥é—®é¢˜**

**å½“å‰å®ç°**ï¼š
```go
// æŒ‰é˜Ÿåˆ—é•¿åº¦æ¯”ä¾‹åˆ†é…èµ„æº
snap.ResourceFraction = snap.IntermediateQueue / totalQMid
```

**é—®é¢˜**ï¼š
- æ²¡æœ‰è€ƒè™‘ä»»åŠ¡çš„ä¼˜å…ˆçº§å’Œæˆªæ­¢æ—¶é—´ï¼ˆdeadlineï¼‰
- æ‰€æœ‰ä»»åŠ¡å¹³ç­‰å¯¹å¾…ï¼Œä¸ç¬¦åˆå®é™…éœ€æ±‚

**å»ºè®®**ï¼š
- å¼•å…¥ **ä»»åŠ¡ä¼˜å…ˆçº§æœºåˆ¶**
- æ”¯æŒ **SLAï¼ˆæœåŠ¡ç­‰çº§åè®®ï¼‰** çº¦æŸ
- å®ç° **å…¬å¹³æ€§ä¿è¯**ï¼ˆé¿å…é¥¥é¥¿ï¼‰

### 4. **è®¾è®¡ä¸åˆç†ä¹‹å¤„**

#### 4.1 Task å’Œ TaskSnapshot èŒè´£ä¸æ¸…
**é—®é¢˜**ï¼š
- Task æ—¢æ˜¯æŒä¹…åŒ–å¯¹è±¡ï¼ŒåˆåŒ…å«è°ƒåº¦çŠ¶æ€
- TaskSnapshot å’Œ Task æœ‰å¤§é‡é‡å¤å­—æ®µ

**å»ºè®®**ï¼š
```go
// Task: åªä¿å­˜æŒä¹…åŒ–ä¿¡æ¯
type Task struct {
    ID     string
    UserID     uint
    DataSize   float64
    Status     TaskStatus
    // ... å…¶ä»–æŒä¹…åŒ–å­—æ®µ
}

// ScheduleContext: è°ƒåº¦è®¡ç®—çš„ä¸´æ—¶ä¸Šä¸‹æ–‡
type ScheduleContext struct {
    ID            string
    CurrentQueue      float64
    ResourceFraction  float64
    // ... å…¶ä»–ä¸´æ—¶å­—æ®µ
}
```

#### 4.2 å…¨å±€å•ä¾‹çš„é™åˆ¶
**é—®é¢˜**ï¼š
- `GetSystemInstance()` å•ä¾‹æ¨¡å¼é™åˆ¶äº†æµ‹è¯•å’Œæ‰©å±•
- æ— æ³•æ¨¡æ‹Ÿå¤šä¸ªç‹¬ç«‹çš„è°ƒåº¦åŸŸ

**å»ºè®®**ï¼š
- æ”¹ä¸ºä¾èµ–æ³¨å…¥æ¨¡å¼
- æ”¯æŒåˆ›å»ºå¤šä¸ª System å®ä¾‹ï¼ˆç”¨äºæµ‹è¯•ã€æ¨¡æ‹Ÿç­‰ï¼‰

### 5. **åŠŸèƒ½å¢å¼ºå»ºè®®** ğŸ’¡

#### 5.1 ä»»åŠ¡ä¾èµ–å…³ç³»
**å»ºè®®æ·»åŠ **ï¼š
```go
type Task struct {
    // ... ç°æœ‰å­—æ®µ
    Dependencies []string  // ä¾èµ–çš„ä»»åŠ¡IDåˆ—è¡¨
    DAGLevel     int       // DAGå±‚çº§ï¼ˆç”¨äºè°ƒåº¦é¡ºåºï¼‰
}
```

#### 5.2 èµ„æºé¢„ç•™æœºåˆ¶
**åœºæ™¯**ï¼šé«˜ä¼˜å…ˆçº§ä»»åŠ¡éœ€è¦é¢„ç•™èµ„æº

**å»ºè®®æ·»åŠ **ï¼š
```go
type CommDevice struct {
    // ... ç°æœ‰å­—æ®µ
    ReservedCapacity float64  // é¢„ç•™å®¹é‡
    ReservationMap   map[string]float64  // taskID -> é¢„ç•™èµ„æº
}
```

#### 5.3 ä»»åŠ¡å–æ¶ˆå’Œè¶…æ—¶æœºåˆ¶
**å½“å‰ç¼ºå¤±**ï¼š
- æ— æ³•å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
- æ²¡æœ‰ä»»åŠ¡è¶…æ—¶æ£€æµ‹

**å»ºè®®æ·»åŠ **ï¼š
```go
func (tm *TaskManager) CancelTask(taskID string) error {
    // å–æ¶ˆä»»åŠ¡å¹¶é‡Šæ”¾èµ„æº
}

func (tm *TaskManager) checkTimeout() {
    // å®šæœŸæ£€æŸ¥è¶…æ—¶ä»»åŠ¡
}
```

#### 5.4 å†å²æ•°æ®å’Œç»Ÿè®¡åˆ†æ
**å»ºè®®æ·»åŠ **ï¼š
```go
type SystemMetrics struct {
    TimeSlot          uint
    AverageDelay      float64
    AverageEnergy     float64
    TaskThroughput    float64
    ResourceUtil      map[uint]float64  // commID -> åˆ©ç”¨ç‡
}

func (s *System) GetMetricsHistory(startTime, endTime time.Time) []SystemMetrics {
    // è¿”å›å†å²æ€§èƒ½æ•°æ®
}
```

#### 5.5 ä»»åŠ¡é‡è¯•æœºåˆ¶
**å½“å‰ç¼ºå¤±**ï¼šå¤±è´¥ä»»åŠ¡çš„å¤„ç†

**å»ºè®®æ·»åŠ **ï¼š
```go
type Task struct {
    // ... ç°æœ‰å­—æ®µ
    RetryCount    int
    MaxRetries    int
    FailureReason string
}

func (tm *TaskManager) RetryFailedTasks() {
    // è‡ªåŠ¨é‡è¯•å¤±è´¥çš„ä»»åŠ¡
}
```

### 6. **ä»£ç è´¨é‡é—®é¢˜**

#### 6.1 é”™è¯¯å¤„ç†ä¸å®Œå–„
```go
// å½“å‰ä»£ç 
func (s *System) loadNodesFromDB() {
    nodes, err := nodeRepo.List(nil)
    if err != nil {
        return  // é™é»˜å¤±è´¥ï¼Œæ²¡æœ‰æ—¥å¿—
    }
}
```

**å»ºè®®**ï¼š
```go
func (s *System) loadNodesFromDB() error {
    nodes, err := nodeRepo.List(nil)
    if err != nil {
        log.Printf("åŠ è½½èŠ‚ç‚¹å¤±è´¥: %v", err)
        return fmt.Errorf("åŠ è½½èŠ‚ç‚¹å¤±è´¥: %w", err)
    }
    // ...
    return nil
}
```

#### 6.2 é­”æ³•æ•°å­—å’Œç¡¬ç¼–ç 
```go
ticker := time.NewTicker(1 * time.Second)  // ç¡¬ç¼–ç 
```

**å»ºè®®**ï¼š
```go
const (
    ScheduleInterval = 1 * time.Second
)
ticker := time.NewTicker(constant.ScheduleInterval)
```

#### 6.3 æ—¥å¿—ä¸å¤Ÿè¯¦ç»†
**å»ºè®®å¢å¼º**ï¼š
```go
log.Printf("[æ—¶éš™ %d] æˆæœ¬: %.2f, ä»»åŠ¡æ•°: %d, æ¼‚ç§»: %.2f, æƒ©ç½š: %.2f, "+
    "å»¶è¿Ÿ: %.2f, èƒ½è€—: %.2f, è´Ÿè½½: %.2f",
    s.T, bestCost, len(activeTasks),
    bestState.Drift, bestState.Penalty,
    bestState.TotalDelay, bestState.TotalEnergy, bestState.Load)
```

### 7. **æ€§èƒ½ä¼˜åŒ–**

#### 7.1 å¯¹è±¡æ± å‡å°‘GCå‹åŠ›
```go
var StatePool = sync.Pool{
    New: func() interface{} {
        return &State{}
    },
}

func (ts *State) Release() {
    // æ¸…ç†åæ”¾å›æ± ä¸­
    StatePool.Put(ts)
}
```

#### 7.2 æ‰¹é‡æ“ä½œä¼˜åŒ–
```go
// å½“å‰æ¯ä¸ªä»»åŠ¡å•ç‹¬æäº¤
func (s *System) SubmitBatchTasks(requests []define.TaskBase) ([]*define.Task, error) {
    // åº”è¯¥ä¸€æ¬¡æ€§åŠ é”å®Œæˆæ‰€æœ‰æ“ä½œ
    s.mutex.Lock()
    defer s.mutex.Unlock()

    // æ‰¹é‡æ·»åŠ 
    for _, req := range requests {
        // ...
    }
}
```

---

## ğŸ¯ ä¼˜å…ˆçº§æ’åº

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. âœ… å¹¶å‘å®‰å…¨é—®é¢˜
2. âœ… é”™è¯¯å¤„ç†å®Œå–„
3. âœ… ä»»åŠ¡å–æ¶ˆå’Œè¶…æ—¶æœºåˆ¶

### ä¸­ä¼˜å…ˆçº§ï¼ˆæ˜¾è‘—æå‡ï¼‰
4. âœ… è°ƒåº¦ç®—æ³•ä¼˜åŒ–ï¼ˆå¢é‡æ›´æ–°ã€æ—©åœï¼‰
5. âœ… ä»»åŠ¡ä¼˜å…ˆçº§å’Œ SLA
6. âœ… åŠ¨æ€æ‹“æ‰‘æ›´æ–°

### ä½ä¼˜å…ˆçº§ï¼ˆåŠŸèƒ½å¢å¼ºï¼‰
7. âœ… å†å²æ•°æ®ç»Ÿè®¡
8. âœ… ä»»åŠ¡ä¾èµ–å…³ç³»
9. âœ… æ€§èƒ½ç›‘æ§å’ŒæŠ¥è­¦

---

## æ€»ç»“

ä½ çš„ç³»ç»Ÿæ•´ä½“è®¾è®¡æ€è·¯æ˜¯æ¸…æ™°çš„ï¼ŒLyapunov ä¼˜åŒ–æ¡†æ¶ä¹Ÿæ˜¯åˆç†çš„ã€‚ä¸»è¦é—®é¢˜é›†ä¸­åœ¨ï¼š

1. **å¹¶å‘å®‰å…¨**ï¼ˆå®¹æ˜“å‡ºç°race conditionï¼‰
2. **ç®—æ³•æ•ˆç‡**ï¼ˆæ·±æ‹·è´å¼€é”€ã€æ—¶é—´å¤æ‚åº¦ï¼‰
3. **åŠŸèƒ½å®Œæ•´æ€§**ï¼ˆç¼ºå°‘å–æ¶ˆã€è¶…æ—¶ã€é‡è¯•ç­‰å…³é”®åŠŸèƒ½ï¼‰
4. **çµæ´»æ€§**ï¼ˆå•ä¾‹æ¨¡å¼ã€é™æ€æ‹“æ‰‘é™åˆ¶äº†æ‰©å±•æ€§ï¼‰

å»ºè®®å…ˆè§£å†³å¹¶å‘å®‰å…¨å’Œé”™è¯¯å¤„ç†ï¼Œå†é€æ­¥ä¼˜åŒ–ç®—æ³•æ€§èƒ½å’Œå¢åŠ åŠŸèƒ½ç‰¹æ€§ã€‚éœ€è¦æˆ‘å¸®ä½ å®ç°æŸä¸ªå…·ä½“çš„ä¼˜åŒ–å—ï¼Ÿ